# -*- coding: UTF-8 -*-import pandasfrom global_values import *from logs import *from merchant import *from compute_month_sales import *def split_data_df_by_month(data_df, start_month, end_month):    return data_df[((data_df.Date_received != 'null') &                    ((months_first_days[start_month - 1] <= data_df.Date_received) &                     (data_df.Date_received < months_first_days[end_month])))                   | ((data_df.Date_received == 'null') &                      ((months_first_days[start_month - 1] <= data_df.Date) &                       (data_df.Date < months_first_days[end_month])))]def grouped_and_compute_features(offline_data_df, online_data_df, start_month, end_month):    data = pandas.DataFrame(pandas.concat([offline_data_df, online_data_df]))    all_merchants_used_coupons = len(data[(data.Coupon_id != 'null') & (data.Date != 'null')].index)    # print all_merchants_used_coupons    all_merchant_month_sales = compute_month_sales(offline_data_df.values, online_data_df.values,                                                   start_month, end_month)    merchant_list = {}    process_cnt = 0    for m_id, group in data.groupby('Merchant_id'):        offline_data = offline_data_df[offline_data_df.Merchant_id == m_id].values        online_data = online_data_df[online_data_df.Merchant_id == m_id].values        mer = Merchant(m_id, start_month, end_month, offline_data, online_data)        mer.compute_all_features(all_merchants_used_coupons, all_merchant_month_sales)        merchant_list[m_id] = mer.to_record()        process_cnt += 1        if process_cnt >= 200 and process_cnt % 200 == 0:            log_info("已处理" + str(process_cnt) + "组数据")        # print mer.to_record()    return merchant_listif __name__ == "__main__":    # 读取文件    log_info("读取文件")    offline_data_train_df = pandas.read_csv('..\..\data\ccf_offline_stage1_train.csv')    online_data_train_df = pandas.read_csv('..\..\data\ccf_online_stage1_train.csv')    # 插入使线上线下相同便于操作，值无所谓    offline_data_train_df.insert(2, 'Action', online_data_train_df['Action'])    online_data_train_df.insert(5, 'Distance', offline_data_train_df['Distance'])    # 计算特征    # 345->3456    log_info("用3-5月数据得到3-6月特征")    offline_data_df_3_5 = split_data_df_by_month(offline_data_train_df, 3, 5)    online_data_df_3_5 = split_data_df_by_month(online_data_train_df, 3, 5)    log_info("分组计算特征")    merchant_list_3_5 = grouped_and_compute_features(offline_data_df_3_5, online_data_df_3_5, 3, 5)    # 456->4567    log_info("用4-6月数据得到4-7月特征")    offline_data_df_4_6 = split_data_df_by_month(offline_data_train_df, 4, 6)    online_data_df_4_6 = split_data_df_by_month(online_data_train_df, 4, 6)    # print offline_data_df_4_6    del online_data_train_df    del offline_data_train_df    log_info("分组计算特征")    merchant_list_4_6 = grouped_and_compute_features(offline_data_df_4_6, online_data_df_4_6, 4, 6)    # 写入文件    log_info("写入文件")    # 3-5月    log_info("写入3-5月文件")    merchant_features_3_5 = []    for m in offline_data_df_3_5[offline_data_df_3_5.Coupon_id != 'null'].values:        merchant_id = m[1]        merchant_features_3_5.append(merchant_list_3_5[merchant_id])    del offline_data_df_3_5    for m in online_data_df_3_5[online_data_df_3_5.Coupon_id != 'null'].values:        merchant_id = m[1]        merchant_features_3_5.append(merchant_list_3_5[merchant_id])    del online_data_df_3_5    merchant_features_3_5_df = pandas.DataFrame(merchant_features_3_5)    merchant_features_3_5_df.to_csv("..\..\data\merchant-features_month3-5.csv", index=False)    del merchant_features_3_5    del merchant_features_3_5_df    # 6月    log_info("写入6月文件")    merchant_features_6 = []    offline_data_6_coupon_df = split_data_df_by_month(offline_data_df_4_6, 6, 6)    offline_data_6_coupon = offline_data_6_coupon_df[offline_data_6_coupon_df.Coupon_id != 'null'].values    # print offline_data_6_coupon_df    del offline_data_6_coupon_df    for m in offline_data_6_coupon:        merchant_id = m[1]        if merchant_id in merchant_list_3_5:            merchant_features_6.append(merchant_list_3_5[merchant_id])        else:            merchant_features_6.append(default_values)    del offline_data_6_coupon    online_data_6_coupon_df = split_data_df_by_month(online_data_df_4_6, 6, 6)    online_data_6_coupon = online_data_6_coupon_df[online_data_6_coupon_df.Coupon_id != 'null'].values    del online_data_6_coupon_df    for m in online_data_6_coupon:        merchant_id = m[1]        if merchant_id in merchant_list_3_5:            merchant_features_6.append(merchant_list_3_5[merchant_id])        else:            merchant_features_6.append(default_values)    del online_data_6_coupon    merchant_features_6_df = pandas.DataFrame(merchant_features_6)    merchant_features_6_df.to_csv("..\..\data\merchant-features_month6.csv", index=False, header=False)    del merchant_features_6    del merchant_features_6_df    del merchant_list_3_5    # 4-6月    merchant_features_4_6 = []    for m in offline_data_df_4_6[offline_data_df_4_6.Coupon_id != 'null'].values:        merchant_id = m[1]        merchant_features_4_6.append(merchant_list_4_6[merchant_id])    for m in online_data_df_4_6[online_data_df_4_6.Coupon_id != 'null'].values:        merchant_id = m[1]        merchant_features_4_6.append(merchant_list_4_6[merchant_id])    merchant_features_4_6_df = pandas.DataFrame(merchant_features_4_6)    merchant_features_4_6_df.to_csv("..\..\data\merchant-features_month4_6.csv", index=False, header=False)    del merchant_features_4_6    del merchant_features_4_6_df    # 7月    # 先取得测试数据顺序    offline_data_test_df = pandas.read_csv('..\..\data\ccf_offline_stage1_test_revised.csv')    test_data_merchant_ids = offline_data_test_df['Merchant_id'].values    # 生成要写入列表    merchant_features_7 = []    for i in test_data_merchant_ids:        if i in merchant_list_4_6:            merchant_features_7.append(merchant_list_4_6[i])        else:            merchant_features_7.append(default_values)    # 写入    merchant_features_7_df = pandas.DataFrame(merchant_features_7)    merchant_features_7_df.to_csv("..\..\data\merchant-features_month7.csv", index=False, header=False)    del merchant_list_4_6    del offline_data_test_df    del test_data_merchant_ids    del merchant_features_7    del merchant_features_7_df    log_info("运行完毕")